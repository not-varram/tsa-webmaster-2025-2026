generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  PUBLIC
  STUDENT
  CHAPTER_ADMIN
  ADMIN
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ResourceType {
  TEMPLATE
  VIDEO
  WORKSHOP
  GUIDE
  TOOL
  EVENT
  SERVICE
}

enum ResourceOrigin {
  WTSA
  CHAPTER
  EXTERNAL_PARTNER
}

enum SuggestionStatus {
  PENDING
  APPROVED
  REJECTED
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
  BORROWED
  RETURNED
  CANCELLED
}

enum PostType {
  REQUEST    // Looking for a resource
  OFFERING   // Offering a resource to share
}

enum PostStatus {
  PENDING    // Awaiting admin approval
  APPROVED   // Visible on forum
  REJECTED   // Rejected by admin
  FILLED     // Request fulfilled or offering claimed
  CLOSED     // Closed by author
}

model User {
  id           String             @id @default(cuid())
  email        String             @unique
  password     String             // Hashed password with salt
  name         String
  role         UserRole           @default(STUDENT)
  chapterId    String?
  chapter      Chapter?           @relation(fields: [chapterId], references: [id])
  tokenVersion Int                @default(0) // Increment to invalidate all existing sessions
  
  // Verification system for students
  verificationStatus VerificationStatus @default(PENDING)
  verifiedById       String?           // Chapter admin who verified this student
  verifiedBy         User?             @relation("VerifiedBy", fields: [verifiedById], references: [id])
  verifiedStudents   User[]            @relation("VerifiedBy")
  verifiedAt         DateTime?
  
  forumThreads     ForumThread[]
  forumReplies     ForumReply[]
  resourceRequests ResourceRequest[]
  
  // Resource posting system
  resourcePosts        ResourcePost[]  @relation("PostAuthor")
  reviewedPosts        ResourcePost[]  @relation("PostReviewer")
  postComments         PostComment[]
  filledPosts          ResourcePost[]  @relation("PostFiller")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([chapterId])
  @@index([verificationStatus])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
}

model Chapter {
  id         String   @id @default(cuid())
  slug       String   @unique
  name       String
  schoolName String
  city       String
  region     String
  about      String   @db.Text
  latitude   Float?
  longitude  Float?
  adminEmails String[] // Emails of chapter admins who can manage this chapter
  
  users              User[]
  resources          Resource[]
  requestsMade       ResourceRequest[]  @relation("RequestingChapter")
  requestsReceived   ResourceRequest[]  @relation("OwningChapter")
  resourcePosts      ResourcePost[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([region])
}

model Resource {
  id          String         @id @default(cuid())
  slug        String         @unique
  title       String
  summary     String
  description String         @db.Text
  type        ResourceType
  audience    String[]
  category    String
  tags        String[]
  origin      ResourceOrigin
  chapterId   String?
  chapter     Chapter?       @relation(fields: [chapterId], references: [id])
  highlighted Boolean        @default(false)
  url         String?
  
  // Physical resource fields
  isPhysical    Boolean   @default(false)
  quantity      Int?      // Total quantity available
  condition     String?   // Good, Fair, Needs Repair, etc.
  location      String?   // Where it's physically located
  availableDate DateTime? // When it becomes available
  
  requests ResourceRequest[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([type])
  @@index([highlighted])
  @@index([chapterId])
  @@index([isPhysical])
}

model Suggestion {
  id           String           @id @default(cuid())
  resourceName String
  description  String           @db.Text
  url          String?
  audience     String
  category     String
  chapterName  String?
  email        String?
  status       SuggestionStatus @default(PENDING)
  
  createdAt DateTime @default(now())

  @@index([status])
}

model Event {
  id            String   @id @default(cuid())
  slug          String   @unique
  title         String
  description   String   @db.Text
  startDatetime DateTime
  endDatetime   DateTime
  type          String
  audience      String[]
  location      String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([startDatetime])
}

model ResourceRequest {
  id                  String        @id @default(cuid())
  resourceId          String
  resource            Resource      @relation(fields: [resourceId], references: [id])
  requestingChapterId String?
  requestingChapter   Chapter?      @relation("RequestingChapter", fields: [requestingChapterId], references: [id])
  owningChapterId     String?
  owningChapter       Chapter?      @relation("OwningChapter", fields: [owningChapterId], references: [id])
  requestedById       String
  requestedBy         User          @relation(fields: [requestedById], references: [id])
  status              RequestStatus @default(PENDING)
  borrowDate          DateTime?
  returnDate          DateTime?
  actualReturnDate    DateTime?
  notes               String?       @db.Text
  adminNotes          String?       @db.Text
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([resourceId])
  @@index([requestingChapterId])
  @@index([owningChapterId])
  @@index([status])
}

model ForumThread {
  id        String   @id @default(cuid())
  title     String
  category  String
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  content   String   @db.Text
  isPinned  Boolean  @default(false)
  isLocked  Boolean  @default(false)
  viewCount Int      @default(0)
  
  replies ForumReply[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([authorId])
  @@index([category])
  @@index([createdAt])
}

model ForumReply {
  id        String      @id @default(cuid())
  threadId  String
  thread    ForumThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  authorId  String
  author    User        @relation(fields: [authorId], references: [id])
  content   String      @db.Text
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([threadId])
  @@index([authorId])
}

// Resource posting system - for community resource requests and offerings
model ResourcePost {
  id          String     @id @default(cuid())
  title       String
  description String     @db.Text
  type        PostType   // REQUEST or OFFERING
  category    String     // e.g., "Technical Materials", "Building Materials", "Equipment"
  tags        String[]
  
  // Author info
  authorId    String
  author      User       @relation("PostAuthor", fields: [authorId], references: [id])
  chapterId   String?
  chapter     Chapter?   @relation(fields: [chapterId], references: [id])
  
  // Contact info (filled by responders)
  contactName  String?
  contactEmail String?
  contactPhone String?
  contactNotes String?   @db.Text
  
  // Status and approval
  status        PostStatus @default(PENDING)
  reviewedById  String?
  reviewedBy    User?      @relation("PostReviewer", fields: [reviewedById], references: [id])
  reviewedAt    DateTime?
  rejectionReason String?  @db.Text
  
  // Fulfillment
  filledById    String?
  filledBy      User?      @relation("PostFiller", fields: [filledById], references: [id])
  filledAt      DateTime?
  
  // Forum comments
  comments PostComment[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([authorId])
  @@index([chapterId])
  @@index([status])
  @@index([type])
  @@index([category])
  @@index([createdAt])
}

model PostComment {
  id        String       @id @default(cuid())
  postId    String
  post      ResourcePost @relation(fields: [postId], references: [id], onDelete: Cascade)
  authorId  String
  author    User         @relation(fields: [authorId], references: [id])
  content   String       @db.Text
  
  // For marking a comment as the "fulfillment" response
  isFulfillment Boolean  @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([postId])
  @@index([authorId])
  @@index([createdAt])
}
